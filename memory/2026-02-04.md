# 2026-02-04 — Sandbox Debugging Day

## Key Discovery: SDK Version Mismatch
- We had `@cloudflare/sandbox@0.1.4` talking to container runtime `sandbox:0.7.0`
- This caused `startProcess` to throw `TypeError: Cannot read properties of undefined (reading 'id')` — response format completely different between versions
- **Fix:** Updated SDK to `@cloudflare/sandbox@0.7.0` — `startProcess` now works, returns process ID, env vars pass through

## Bugs Found & Fixed
1. **Wrong API endpoint**: Worker was calling `/api/v1/chat` (doesn't exist). OpenClaw uses `/v1/chat/completions` (OpenAI-compatible). Need `chatCompletions.enabled: true` in gateway config.
2. **SDK version mismatch** (0.1.4 vs 0.7.0): Process starts but SDK couldn't parse response. Env vars didn't reach container.
3. **Config format**: OpenClaw uses `openclaw.json` (JSON), not `gateway.yaml`. Start script was writing YAML → switched to JSON.
4. **Config filename**: clawdbot@2026.1.24-3 looks for `clawdbot.json`, not `openclaw.json`. Now writes to both `/root/.clawdbot/` and `/root/.openclaw/`.
5. **Config missing mode**: Gateway needs `gateway.mode=local` set, or `--allow-unconfigured` flag.

## Current Status (end of session)
- **Onboarding**: ✅ fully working, multilingual
- **Thinking UX**: ✅ "⚡ Starting up..." message + typing loop + message edit
- **SDK**: ✅ fixed (0.7.0), env vars confirmed working (GOOGLE_API_KEY: YES, User: Alaa)
- **Config**: ✅ written to both paths, `--allow-unconfigured` flag added
- **Last error**: `Missing config. Run clawdbot setup or set gateway.mode=local` — should be fixed by config path fix + flag, awaiting test from Alaa
- **Last deploy**: `15870133-fa7c-4309-a5bb-45b617405880` with both config paths

## Alaa's Feedback
- Wants progress messages while I work (send Telegram updates during long operations) — implemented via `message` tool
- "Don't deploy before testing" — be more methodical
- Likes the thinking message approach
- Asked about double API calls for progress messages → answered: just Telegram HTTP, not AI calls

## Architecture Confirmed
```
Telegram → Worker → getSandbox('user-{id}') → startProcess(start-zaki.sh, {env}) 
→ waitForPort(18789) → containerFetch('/v1/chat/completions') → response → Telegram
```

## Files Modified
- `src/index.ts` — Fixed endpoint, added thinking UX, SDK 0.7.0 compatible code
- `start-zaki.sh` — JSON config (not YAML), dual config paths, --allow-unconfigured
- `package.json` — `@cloudflare/sandbox` upgraded 0.1.4 → 0.7.0
- `docs/BUILD_PROGRESS.md` — Full status doc created
- `src/onboarding.ts` — No changes needed, works great

## Key Technical Notes
- Cloudflare Sandbox internal API: `http://localhost:3000/api/process/start`
- OpenClaw chat completions endpoint: `GET/POST /v1/chat/completions` with `Authorization: Bearer {token}`
- Container cold start after deploy: needs 30-60s, `Error checking 3000` is normal during boot
- `filterEnvVars()` in SDK just removes null/undefined — doesn't strip anything
- Workers paid plan: 30s CPU / 15min wall time — enough for 90s port polling
